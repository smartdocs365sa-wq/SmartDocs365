<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Password Reset Form</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding-top: 5%;
        align-items: center;
        height: 100vh;
        background-color: #f5f5f5;
        margin: 0;
      }
      form {
        background-color: #ffffff;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
      input {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
      }
      button {
        background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
        color: #ffffff; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;
      }
      button:hover { opacity: 0.9; }
      .password-container { position: relative; }
      .password-toggle {
        position: absolute; right: 10px; top: 38px; cursor: pointer; color: #666; font-size: 12px;
      }
      #logo img { height: 60px; width: auto; margin-bottom: 20px; }
      #successPopup { text-align: center; background-color: #dcfce7; color: #166534; padding: 20px; border-radius: 8px; display: none; border: 1px solid #86efac; }
      #closeButton { background-color: #1e40af; margin-top: 15px; }
    </style>
  </head>
  <body>
    <div id="logo">
      <img src="https://smartdocs365-backend.onrender.com/logo.jpg" alt="SmartDocs365" />
    </div>

    <form id="resetPasswordForm" onsubmit="resetPassword(event)">
      <h3 style="text-align: center; margin-top: 0; color: #333;">Reset Password</h3>
      
      <div class="password-container">
        <label for="password">New Password</label>
        <input type="password" id="password" required minlength="8" />
        <span class="password-toggle" onclick="togglePassword('password')" data-target="password">Show</span>
      </div>

      <div class="password-container">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" required />
        <span class="password-toggle" onclick="togglePassword('confirmPassword')" data-target="confirmPassword">Show</span>
      </div>

      <button type="submit" id="submitBtn">Reset Password</button>
    </form>

    <div id="successPopup">
      <h3>Success!</h3>
      <p>Your password has been reset successfully.</p>
      <button id="closeButton" onclick="window.location.href='https://smartdocs365.com/login'">Go To Login</button>
    </div>

    <script>
      async function resetPassword(event) {
        event.preventDefault();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const btn = document.getElementById("submitBtn");

        if (password !== confirmPassword) { alert("Passwords do not match"); return; }
        if (password.length < 8) { alert("Password must be at least 8 characters"); return; }

        // Extract Token from URL
        const pathSegments = window.location.pathname.split('/');
        const token = pathSegments[pathSegments.length - 1];

        // âœ… CORRECTED API URL
        const apiUrl = `https://smartdocs365-backend.onrender.com/api/update/reset-password-set/${token}`;

        btn.innerText = "Processing...";
        btn.disabled = true;

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
          });
          
          const data = await response.json();

          if (response.ok && data.success) {
            document.getElementById("resetPasswordForm").style.display = "none";
            document.getElementById("successPopup").style.display = "block";
          } else {
            alert(data.message || "Reset failed. Link may be expired.");
            btn.innerText = "Reset Password";
            btn.disabled = false;
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Connection error. Please try again.");
          btn.innerText = "Reset Password";
          btn.disabled = false;
        }
      }

      function togglePassword(id) {
        const input = document.getElementById(id);
        const toggle = document.querySelector(`[data-target="${id}"]`);
        if (input.type === "password") {
          input.type = "text";
          toggle.innerText = "Hide";
        } else {
          input.type = "password";
          toggle.innerText = "Show";
        }
      }
    </script>
  </body>
</html>